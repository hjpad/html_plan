<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML_Plan</title>
    <link rel="icon" type="image/x-icon" href="images/favicons/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicons/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicons/favicon-32x32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicons/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="144x144" href="images/favicons/favicon-144x144.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="images/favicons/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="images/favicons/android-chrome-512x512.png" />
    <link rel="manifest" href="app.webmanifest" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles/utils.css">
    <link rel="stylesheet" href="styles/auth.css">
    <link rel="stylesheet" href="styles/plan.css">
</head>
<body>

    <!-- Login Form Container -->
    <div id="login-container">
        <div id="login-box">
            <h1 class="app-name-login">html_plan</h1>
            <form id="loginForm">
                <div class="mb-3">
                    <input type="email" class="form-control" id="loginEmail" placeholder="Email address" required>
                </div>
                <div class="mb-3 position-relative"> <!-- Added position-relative for icon positioning -->
                    <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
                    <button type="button" class="password-toggle-btn" id="togglePassword">
                        <i class="bi bi-eye-slash"></i> <!-- Eye slash icon by default -->
                    </button>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-2">Login</button>
                <button type="button" class="btn btn-outline-secondary w-100 d-none" id="registerBtn">Register (First-time user)</button>
                <div id="loginMessage" class="mt-3 text-danger"></div>
            </form>
        </div>
    </div>

    <!-- Main App Wrapper (Contains Header and Main Content/Detail View) -->
    <div id="main-app-wrapper" style="display: none;" class="d-flex flex-column flex-grow-1">
        <header class="d-flex align-items-center p-2 p-md-3">
            <div id="app-name" class="order-1 d-none d-md-block">html_plan</div>
            <div id="search-field" class="input-group order-2 flex-grow-1 mx-md-3">
                <input type="text" class="form-control" placeholder="Search projects or tasks..." id="globalSearchInput">
                <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn"><i class="bi bi-x-lg"></i></button>
            </div>
            <div id="user-controls" class="order-3">
                <div class="dropdown">
                    <button class="btn btn-light" type="button" id="userIconDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle fs-4"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userIconDropdown">
                        <li><h6 class="dropdown-header">Settings</h6></li>
                        <li>
                            <div class="form-check form-switch dropdown-item px-4">
                                <input class="form-check-input" type="checkbox" id="darkModeSwitch">
                                <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item" id="logoutBtn">Logout</button></li>
                    </ul>
                </div>
            </div>
        </header>

        <!-- Container for Main Content Area and Detail Offcanvas -->
        <div id="main-layout-container" class="d-flex flex-grow-1">
            <!-- Main Content Area (Tabs) -->
            <div id="main-content-area" class="d-flex flex-column flex-grow-1">
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects-content" type="button" role="tab" aria-controls="projects-content" aria-selected="true">Projects</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks-content" type="button" role="tab" aria-controls="tasks-content" aria-selected="false">Tasks</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar-content" type="button" role="tab" aria-controls="calendar-content" aria-selected="false">Calendar</button>
                    </li>
                </ul>

                <div class="tab-content flex-grow-1" id="mainTabContent">
                    <!-- Projects Tab Content -->
                    <div class="tab-pane fade show active" id="projects-content" role="tabpanel" aria-labelledby="projects-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <button class="btn btn-primary" id="addProjectBtn">
                                <i class="bi bi-plus-lg"></i> Add Project
                            </button>
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="projectsSortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        Sort by: Name
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="projectsSortDropdown">
                                        <li><a class="dropdown-item" href="#" data-sort="name">Name</a></li>
                                        <li><a class="dropdown-item" href="#" data-sort="date">Due Date</a></li>
                                    </ul>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="hideCompletedProjectsSwitch">
                                    <label class="form-check-label" for="hideCompletedProjectsSwitch">Hide Completed</label>
                                </div>
                                <div class="btn-group" role="group" aria-label="Projects collapse/expand">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="collapseAllProjectsBtn" title="Collapse all projects"><i class="bi bi-dash-square"></i></button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="expandAllProjectsBtn" title="Expand all projects"><i class="bi bi-plus-square"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-striped" id="projectsTable">
                                <thead>
                                    <tr>
                                        <th style="width: 5%;" class="sticky-column"></th> <!-- For Collapse Toggle -->
                                        <th style="width: 30%;" class="sticky-column">Title</th>
                                        <th style="width: 15%;">Start Date</th>
                                        <th style="width: 15%;">Due Date</th>
                                        <th style="width: 10%;">Priority</th>
                                        <th style="width: 15%;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Projects and Tasks will be rendered here by JS -->
                                </tbody>
                            </table>
                        </div>
                        <p id="noProjectsMessage" class="text-center text-muted mt-5" style="display:none;">No projects yet. Click "Add Project" to get started!</p>
                    </div>

                    <!-- Tasks Tab Content -->
                    <div class="tab-pane fade" id="tasks-content" role="tabpanel" aria-labelledby="tasks-tab">
                        <div class="d-flex justify-content-end mb-3 gap-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="hideCompletedTasksSwitch">
                                <label class="form-check-label" for="hideCompletedTasksSwitch">Hide Completed</label>
                            </div>
                            <div class="btn-group" role="group" aria-label="Tasks collapse/expand">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="collapseAllTasksBtn" title="Collapse all status groups"><i class="bi bi-dash-square"></i></button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="expandAllTasksBtn" title="Expand all status groups"><i class="bi bi-plus-square"></i></button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-striped" id="tasksTable">
                                <thead>
                                    <tr>
                                        <th style="width: 30%;" class="sticky-column">Title</th>
                                        <th style="width: 20%;" class="sticky-column-2">Project</th>
                                        <th style="width: 15%;">Start Date</th>
                                        <th style="width: 15%;">Due Date</th>
                                        <th style="width: 10%;">Priority</th>
                                        <th style="width: 10%;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Tasks will be rendered here by JS -->
                                </tbody>
                            </table>
                        </div>
                        <p id="noTasksMessage" class="text-center text-muted mt-5" style="display:none;">No tasks yet. Add tasks from Project detail view.</p>
                    </div>

                    <!-- Calendar Tab Content -->
                    <div class="tab-pane fade" id="calendar-content" role="tabpanel" aria-labelledby="calendar-tab">
                        <div class="calendar-nav">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" id="prevMonthBtn"><i class="bi bi-chevron-left"></i></button>
                                <button class="btn btn-outline-secondary" id="nextMonthBtn"><i class="bi bi-chevron-right"></i></button>
                                <button class="btn btn-primary" id="todayBtn">Today</button>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <select class="form-select w-auto" id="monthSelect"></select>
                                <select class="form-select w-auto" id="yearSelect"></select>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="hideCompletedCalendarSwitch">
                                    <label class="form-check-label" for="hideCompletedCalendarSwitch">Hide Completed</label>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="calendarViewDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        View: Due Date
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="calendarViewDropdown">
                                        <li><a class="dropdown-item" href="#" data-view="timespan">Time Span</a></li>
                                        <li><a class="dropdown-item" href="#" data-view="duedate">Only Due Date</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Day headers -->
                            <div class="calendar-day-header">Sun</div>
                            <div class="calendar-day-header">Mon</div>
                            <div class="calendar-day-header">Tue</div>
                            <div class="calendar-day-header">Wed</div>
                            <div class="calendar-day-header">Thu</div>
                            <div class="calendar-day-header">Fri</div>
                            <div class="calendar-day-header">Sat</div>
                            <!-- Calendar days will be rendered here by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sideview (Offcanvas) for Task/Project Details -->
            <div class="offcanvas offcanvas-end" tabindex="-1" id="detailOffcanvas" aria-labelledby="detailOffcanvasLabel" data-bs-backdrop="false" data-bs-scroll="true">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="detailOffcanvasLabel">Item Details</h5>
                    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <div class="offcanvas-resize-handle"></div> <!-- Draggable resize handle -->
                    <form id="detailForm">
                        <input type="hidden" id="detailItemId">
                        <input type="hidden" id="detailItemType"> <!-- 'project' or 'task' -->
                        <input type="hidden" id="detailItemParentId">

                        <div class="mb-3">
                            <label for="detailTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="detailTitle" required>
                        </div>

                        <!-- New: Project dropdown for tasks -->
                        <div class="mb-3" id="detailTaskProjectField" style="display: none;">
                            <label for="detailTaskProjectSelect" class="form-label">Project</label>
                            <select class="form-select" id="detailTaskProjectSelect">
                                <!-- Options populated by JS -->
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dates</label>
                            <div class="input-group date-inputs">
                                <input type="date" class="form-control" id="detailStartDate" title="Start Date">
                                <span class="input-group-text">-</span>
                                <input type="date" class="form-control" id="detailDueDate" title="Due Date">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="detailPriority" class="form-label">Priority</label>
                                <select class="form-select" id="detailPriority">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="detailStatus" class="form-label">Status</label>
                                <select class="form-select" id="detailStatus">
                                    <option value="To Do">To Do</option>
                                    <option value="Do Now">Do Now</option>
                                    <option value="On Hold">On Hold</option>
                                    <option value="Complete">Complete</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="detailDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="detailDescription" rows="5"></textarea>
                        </div>

                        <!-- New: Nested Task List for Projects -->
                        <div id="projectTasksListContainer" class="project-tasks-list-container" style="display: none;">
                            <div class="project-tasks-list-header">
                                <h6 class="mb-0">Tasks in this Project</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="hideCompletedProjectTasksSwitch">
                                    <label class="form-check-label" for="hideCompletedProjectTasksSwitch">Hide Completed</label>
                                </div>
                            </div>
                            <ul class="project-tasks-list" id="projectTasksList">
                                <!-- Project's tasks will be rendered here by JS -->
                            </ul>
                            <p id="noProjectTasksMessage" class="text-center text-muted py-2" style="display: none;">No tasks in this project yet. Use "Add Task" below.</p>
                        </div>

                        <div class="detail-buttons mt-auto">
                            <!-- Save button removed for auto-save -->
                            <button type="button" class="btn btn-outline-primary" id="addNestedTaskBtn" style="display:none;">
                                <i class="bi bi-plus-lg"></i> Add Task
                            </button>
                            <button type="button" class="btn btn-outline-danger" id="deleteItemBtn">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Your Firebase Config (should be loaded before auth.mjs uses it) -->
    <script src="scripts/firebaseConfig.js"></script>
    <!-- Initialize Firebase App *before* your modules try to use it -->
    <script>
        if (typeof firebaseConfig === 'undefined') {
            console.error("Firebase initialization error: firebaseConfig is not defined.");
        } else {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase app initialized successfully.");
        }
    </script>
    <!-- Local Bootstrap JS -->
    <script src="scripts/bootstrap.bundle.min.js"></script>
    <!-- Your Application Scripts (type="module" allows import/export) -->
    <script type="module" src="scripts/utils.mjs"></script>
    <script type="module" src="scripts/auth.mjs"></script>
    <script type="module" src="scripts/firestore.mjs"></script>
    <script type="module" src="scripts/plan.mjs"></script>

</body>
</html>